config:
   name: 待确认提车后更换牌照 testcases/order/tobeconfirmed/change_ License_plate.yml
   variables:
      carTypeName: ${get_config(carFullName)}
      phoneNum: ${ENV(phoneNum)}
      environment: ${ENV(environment)}
      orderstatustimeout: ${get_config(orderstatustimeout)}
teststeps:
   - name: 创建车辆 testcases/supply/skipIf_create_car.yml
     testcase: testcases/supply/skipIf_create_car.yml
     setup_hooks:
        - ${run_audit_order()}
        - ${run_get_user_message()}
     validate:
        - eq: [status_code, 200]

   - name: 获取待售未锁车辆列表 api/supplychain/Get_Cars_ condition.yml
     api: api/supplychain/Get_Cars_ condition.yml
     variables:
        carTypeName: ${get_config(carFullName)}
     validate:
        - eq: [status_code, 200]
     extract:
        - vin: content.0.vin

   - name: 创建待售车辆订单并提交  testcases/order/APP_create_order.yml
     testcase: testcases/order/APP_create_order.yml
     variables:
        keyword: $carTypeName
     validate:
        - eq: [status_code, 200]

   - name: 获取订单号 api/mall/salesman/POST_Order.yml
     api: api/mall/salesman/POST_Order.yml
     validate:
        - eq: [status_code,200]
     extract:
        - orderId: content.0.orderId
        - tradeNo: content.0.tradeNo


   - name: 验证库存：已锁车、待售  api/supplychain/GET_Cars.yml
     api: api/supplychain/GET_Cars.yml
     variables:
        vin: ${vin}
        carTypeName: ${get_config(carFullName)}
     validate:
        - eq: [status_code,200]
        - eq: [content.0.locked, true]
        - eq: [content.0.sold, false]
        - eq: [content.0.tradeNo,$tradeNo]

   - name: 验证订单状态：等待审核 api/mall/back-end/orders/POST_Params.yml
     api: api/mall/back-end/orders/POST_Params.yml
     variables:
        tradeNo: ${tradeNo}
     validate:
        - eq: [content.0.orderStatusDesc,"等待审核"]
        - eq: [content.0.orderDetail.carItemStatus, 9]

   - name: 信审账号登录  testcases/login/trial_account_login.yml
     testcase: testcases/login/trial_account_login.yml
     validate:
        - eq: [status_code,200]
     setup_hooks:
        - ${sleep(60)}


   - name: 审核订单  testcases/order/audit_order.yml
     testcase: testcases/order/audit_order.yml
     validate:
        - eq: [status_code, 200]
     teardown_hooks:
       - ${order_status_change_time($orderstatustimeout,$environment)}
     setup_hooks:
       - ${get_audit_list()}

   - name: 验证订单状态：订单处理中、待售 api/mall/back-end/orders/POST_Params.yml
     api: api/mall/back-end/orders/POST_Params.yml
     variables:
        tradeNo: ${tradeNo}
     validate:
        - eq: [content.0.orderStatusDesc,"订单处理中"]
        - eq: [content.0.orderDetail.carItemStatus, 9]
     setup_hooks:
        - ${sleep(30)}

   - name: 完善还款信息  api/mall/mallSignAgreementInfo/anybank/POST_Sign.yml
     api: api/mall/mallSignAgreementInfo/anybank/POST_Sign.yml
     variables:
        orderId: $orderId
     validate:
        - eq: [status_code,200]
     teardown_hooks:
        - ${sleep(10)}

   - name: 验证订单状态：待签署合同 api/mall/back-end/orders/POST_Params.yml
     api: api/mall/back-end/orders/POST_Params.yml
     variables:
        tradeNo: ${tradeNo}
     validate:
        - eq: [content.0.orderStatusDesc,"待签署合同"]
        - eq: [content.0.orderDetail.carItemStatus, 9]
     teardown_hooks:
        - ${sql_init_contract($response)}

   - name: 验证订单状态：待确认提车 api/mall/back-end/orders/POST_Params.yml
     api: api/mall/back-end/orders/POST_Params.yml
     variables:
        tradeNo: ${tradeNo}
     validate:
        - eq: [content.0.orderStatusDesc,"待确认提车"]

   - name: 可更换车辆列表 api/mall/orders/GET_IicensePlateList.yml
     api: api/mall/orders/GET_IicensePlateList.yml
     variables:
       orderId: $orderId
     extract:
       lockCarIdT: content.0.erpCarId
       targetOrderIdT: content.0.orderId
       lockCarIdF: content.1.erpCarId
       targetOrderIdF: content.1.orderId
       carLicenseNumberT: content.0.carLicenseNumber
       carLicenseNumberF: content.1.carLicenseNumber
     validate:
        - eq: [status_code,200]
     teardown_hooks:
        - ${save_skip_CarNo($response,$orderId)}

   - name: 更换牌照(非首条记录) api/mall/orders/GET_ChangeLicensePlate.yml
     api: api/mall/orders/GET_ChangeLicensePlate.yml
     skipIf: ${get_value_from_tmp("skip")}
     variables:
       orderId: $orderId
       sellerId: ${get_value_from_tmp(sellerId)}
       lockCarId: $lockCarIdT
       targetOrderId: $targetOrderIdT
     validate:
       - eq: [status_code,200]
     teardown_hooks:
         - ${save_carLicenseNumber_form_response($carLicenseNumberT)}

   - name: 更换牌照(首条记录) api/mall/orders/GET_ChangeLicensePlate.yml
     api: api/mall/orders/GET_ChangeLicensePlate.yml
     skipUnless: ${get_value_from_tmp("skip")}
     variables:
       orderId: $orderId
       sellerId: ${get_value_from_tmp(sellerId)}
       lockCarId: $lockCarIdF
       targetOrderId: $targetOrderIdF
     validate:
       - eq: [status_code,200]
     teardown_hooks:
       - ${save_carLicenseNumber_form_response($carLicenseNumberF)}

   - name: 验证订单状态：待签署合同 api/mall/back-end/orders/POST_Params.yml
     api: api/mall/back-end/orders/POST_Params.yml
     variables:
       tradeNo: ${tradeNo}
       carLicenseNumber: ${get_value_from_tmp(carLicenseNumber)}
     validate:
       - eq: [content.0.orderStatusDesc,"待签署合同"]
       - eq: [content.0.orderDetail.carLicenseNumber,$carLicenseNumber]
     teardown_hooks:
         - ${sql_init_contract($response)}

   - name: 验证订单状态：待确认提车 api/mall/back-end/orders/POST_Params.yml
     api: api/mall/back-end/orders/POST_Params.yml
     variables:
        tradeNo: ${tradeNo}
     validate:
        - eq: [content.0.orderStatusDesc,"待确认提车"]

   - name: 发起出库流程  api/mall/order-deliveries/POST_LaunchDelivery.yml
     api: api/mall/order-deliveries/POST_LaunchDelivery.yml
     variables:
        orderId: $orderId
        sellerId: ${get_value_from_tmp(sellerId)}
     validate:
        - eq: [status_code,200]

   - name: 验证订单状态：待确认提车 api/mall/back-end/orders/POST_Params.yml
     api: api/mall/back-end/orders/POST_Params.yml
     variables:
        tradeNo: ${tradeNo}
     validate:
        - eq: [content.0.orderStatusDesc,"待确认提车"]

   - name: APP端确认提车  api/mall/orders/PUT_ComfirmOrder.yml
     api: api/mall/orders/PUT_ComfirmOrder.yml
     variables:
        orderId: $orderId
     validate:
        - eq: [status_code,200]

   - name: 验证订单状态：交易完成 api/mall/back-end/orders/POST_Params.yml
     api: api/mall/back-end/orders/POST_Params.yml
     variables:
       tradeNo: ${tradeNo}
       phoneNum: $phoneNum
     validate:
       - eq: [content.0.orderStatusDesc,"交易完成"]
       - eq: [content.0.orderDetail.carItemStatus, 99]
     teardown_hooks:
         - ${sql_init_order($phoneNum)}
