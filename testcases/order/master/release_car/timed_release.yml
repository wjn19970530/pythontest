config:
    name: 定时释放车源  testcases/order/master/release_car/timed_release.yml
    variables:
      brandName: ${get_config(carBrandName)}
      seriesName: ${get_config(carSeriesName)}
      typeName: ${get_config(carTypeName)}
      carFullName: ${get_car_full_name($brandName,$seriesName,$typeName)}

teststeps:
#  - name: 保存未审核订单数量 testcases/order/master/nonaudit_order_count.yml
#    testcase: testcases/order/master/nonaudit_order_count.yml
#    validate:
#      - eq: [status_code, 200]
#
#  - name: 审核订单  testcases/order/master/audit_order_without_sleep.yml
#    testcase: testcases/order/master/audit_order_without_sleep.yml
#    validate:
#      - eq: [status_code, 200]

#  - name: 获取账户信息  api/account/GET_Account.yml
#    api: api/account/GET_Account.yml
#    validate:
#      - eq: [status_code, 200]
#    teardown_hooks:
#      - ${save_seller_id_form_response($response)}
#
#  - name: 获取客户列表  api/usercenter/users/POST_Customer.yml
#    api: api/usercenter/users/POST_Customer.yml
#    validate:
#      - eq: [status_code,200]

#  - name: 释放车源状态的有效订单发起退款 testcases/order/master/refund_release_car.yml
#    testcase: testcases/order/master/refund_release_car.yml
#    validate:
#      - eq: [status_code,200]
#
#  - name: 待售状态的有效订单发起退款  testcases/order/master/refund_for_sale.yml
#    testcase: testcases/order/master/refund_for_sale.yml
#    validate:
#      - eq: [status_code,200]
#    teardown_hooks:
#      - ${sleep(5)}

  - name: 添加待售车辆  testcases/supply/skipIf_create_car.yml
    testcase: testcases/supply/skipIf_create_car.yml
    setup_hooks:
      - ${run_get_user_message()}
      - ${run_master_audit_order()}
      - ${run_refund_order()}
      - ${sleep(5)}
    validate:
      - eq: [status_code,200]

  - name: 获取待售车辆  api/supplychain/GET_UnlockedCars.yml
    api: api/supplychain/GET_UnlockedCars.yml
    variables:
      carTypeName: $carFullName
      isLocked: 0
      carStstus: 4
    validate:
      - eq: [status_code,200]
    extract:
      vin: content.0.vin
    output:
      - vin

  - name: 验证车辆状态:未锁车、待售  api/supplychain/GET_Cars.yml
    api: api/supplychain/GET_Cars.yml
    variables:
      vin: ${vin}
      carTypeName: $carFullName
    validate:
      - eq: [status_code,200]
      - eq: [content.0.locked, false]
      - eq: [content.0.sold, false]

  - name: 下单 testcases/order/master/create_order.yml
    testcase: testcases/order/master/create_order.yml
    variables:
      keyword: $carFullName
    validate:
      - eq: [status_code,200]

  - name: 获取订单号 api/mall/salesman/POST_Order.yml
    api: api/mall/salesman/POST_Order.yml
    validate:
      - eq: [status_code,200]
    extract:
      - tradeNo: content.0.tradeNo
      - orderId: content.0.orderId

  - name: 验证库存：已锁车、待售  api/supplychain/GET_Cars.yml
    api: api/supplychain/GET_Cars.yml
    variables:
      vin: ${vin}
      carTypeName: $carFullName
    validate:
      - eq: [status_code,200]
      - eq: [content.0.locked, true]
      - eq: [content.0.sold, false]
      - eq: [content.0.tradeNo, $tradeNo]

  - name: 验证订单状态：等待审核 api/mall/back-end/orders/POST_Params.yml
    api: api/mall/back-end/orders/POST_Params.yml
    variables:
      tradeNo: ${tradeNo}
    validate:
      - eq: [content.0.orderStatusDesc,"等待审核"]
      - eq: [content.0.orderDetail.carItemStatus, 9]

  - name: 释放车源-定时释放 api/mall/orders/release-car/PUT_UpdateReleaseTime.yml
    api: api/mall/orders/release-car/PUT_UpdateReleaseTime.yml
    variables:
        orderId: ${orderId}
    validate:
      - eq: [status_code,200]

  - name: 验证订单状态：等待审核、待售 api/mall/back-end/orders/POST_Params.yml
    api: api/mall/back-end/orders/POST_Params.yml
    variables:
      tradeNo: ${tradeNo}
    validate:
      - eq: [content.0.orderStatusDesc,"等待审核"]
      - eq: [content.0.orderDetail.carItemStatus, 9]

  - name: 验证库存：已锁车、待售  api/supplychain/GET_Cars.yml
    api: api/supplychain/GET_Cars.yml
    variables:
      vin: ${vin}
      carTypeName: $carFullName
    validate:
      - eq: [status_code,200]
      - eq: [content.0.locked, true]
      - eq: [content.0.sold, false]
      - eq: [content.0.tradeNo, $tradeNo]

  - name: 验证订单状态：等待审核、释放车源 api/mall/back-end/orders/POST_Params.yml
    api: api/mall/back-end/orders/POST_Params.yml
    setup_hooks:
      - ${sleep(75)}
    variables:
      tradeNo: ${tradeNo}
    validate:
      - eq: [content.0.orderStatusDesc,"等待审核"]
      - eq: [content.0.orderDetail.carItemStatus, 11]

  - name: 验证库存：未锁车、待售  api/supplychain/GET_Cars.yml
    api: api/supplychain/GET_Cars.yml
    variables:
      vin: ${vin}
      carTypeName: $carFullName
    validate:
      - eq: [status_code,200]
      - eq: [content.0.locked, false]
      - eq: [content.0.sold, false]
      - eq: [content.0.tradeNo,null]

  - name: 发起退款   api/mall/orders/PUT_PrepareReturn.yml
    api: api/mall/orders/PUT_PrepareReturn.yml
    variables:
      orderId: $orderId
    validate:
      - eq: [status_code,200]

  - name: 验证订单状态：等待审核、待退款 api/mall/back-end/orders/POST_Params.yml
    api: api/mall/back-end/orders/POST_Params.yml
    variables:
      tradeNo: ${tradeNo}
    validate:
      - eq: [content.0.orderStatusDesc,"待退款"]

  - name: 确认退款  api/mall/orders/PUT_ConfirmReturn.yml
    api: api/mall/orders/PUT_ConfirmReturn.yml
    variables:
      orderId: $orderId
    validate:
      - eq: [status_code,200]

  - name: 验证订单状态：交易取消 api/mall/back-end/orders/POST_Params.yml
    api: api/mall/back-end/orders/POST_Params.yml
    variables:
      tradeNo: ${tradeNo}
    validate:
      - eq: [content.0.orderStatusDesc,"交易取消"]
    teardown_hooks:
      - ${run_master_audit_order()}
      - ${run_refund_order()}