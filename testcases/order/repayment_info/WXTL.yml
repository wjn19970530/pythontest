config:
    name: 还款信息:万向通联 testcases/order/repayment_info/WXTL.yml
    variables:
        brandName: ${get_config(carBrandName)}
        seriesName: ${get_config(carSeriesName)}
        typeName: 'WXTL'
        carFullName: ${get_car_full_name($brandName,$seriesName,$typeName)}
        phoneNum: ${ENV(phoneNum)}
        environment: ${ENV(environment)}
        orderstatustimeout: ${get_config(orderstatustimeout)}

teststeps:

  - name: 获取账户信息  api/account/GET_Account.yml
    api: api/account/GET_Account.yml
    validate:
      - eq: [status_code, 200]
    teardown_hooks:
      - ${save_seller_id_form_response($response)}

  - name: 获取客户列表  api/usercenter/users/POST_Customer.yml
    api: api/usercenter/users/POST_Customer.yml
    variables:
      queryName: ${ENV(phoneNum)}
    validate:
      - eq: [status_code,200]

  - name: 添加待售车辆  testcases/supply/skipIf_create_car.yml
    testcase: testcases/supply/skipIf_create_car.yml
    variables:
      carTypeName: $carFullName
    validate:
      - eq: [status_code,200]
    teardown_hooks:
      - ${sleep(5)}

  - name: 获取车辆id api/mall/back-end/car-items/POST_List.yml
    api: api/mall/back-end/car-items/POST_List.yml
    variables:
      type: $typeName
    validate:
      - eq: [status_code,200]
    teardown_hooks:
      - ${save_car_id_from_response($response,$carFullName)}
      - ${sleep(2)}

  - name: 获取待售车辆  api/supplychain/GET_UnlockedCars.yml
    api: api/supplychain/GET_UnlockedCars.yml
    variables:
      carTypeName: $carFullName
      isLocked: 0
      carStstus: 4
    validate:
      - eq: [status_code,200]
    extract:
      vin: content.0.vin
    output:
      - vin

  - name: 验证车辆状态:未锁车、待售  api/supplychain/GET_Cars.yml
    api: api/supplychain/GET_Cars.yml
    variables:
      vin: ${vin}
      carTypeName: $carFullName
    validate:
      - eq: [status_code,200]
      - eq: [content.0.locked, false]
      - eq: [content.0.sold, false]

  - name: 下单 testcases/order/APP_create_order.yml
    testcase: testcases/order/APP_create_order.yml
    variables:
        keyword: $carFullName
    validate:
      - eq: [status_code,200]

  - name: 获取订单号 api/mall/salesman/POST_Order.yml
    api: api/mall/salesman/POST_Order.yml
    validate:
      - eq: [status_code,200]
    extract:
      - tradeNo: content.0.tradeNo
      - orderId: content.0.orderId

  - name: 验证库存：已锁车、待售  api/supplychain/GET_Cars.yml
    api: api/supplychain/GET_Cars.yml
    variables:
      vin: ${vin}
      carTypeName: $carFullName
    validate:
      - eq: [status_code,200]
      - eq: [content.0.locked, true]
      - eq: [content.0.sold, false]
      - eq: [content.0.tradeNo,$tradeNo]

  - name: 验证订单状态：等待审核、待售 api/mall/back-end/orders/POST_Params.yml
    api: api/mall/back-end/orders/POST_Params.yml
    variables:
      tradeNo: ${tradeNo}
    validate:
      - eq: [content.0.orderStatusDesc,"等待审核"]
      - eq: [content.0.orderDetail.carItemStatus, 9]

  - name: 信审账号登录  testcases/login/trial_account_login.yml
    testcase: testcases/login/trial_account_login.yml
    validate:
      - eq: [status_code,200]
    setup_hooks:
      - ${sleep(60)}
      - ${get_audit_list()}

  - name: 审核订单  testcases/order/audit_order.yml
    testcase: testcases/order/audit_order.yml
    validate:
      - eq: [status_code,200]

  - name: 验证订单状态：订单处理中 api/mall/back-end/orders/POST_Params.yml
    api: api/mall/back-end/orders/POST_Params.yml
    variables:
        tradeNo: ${tradeNo}
    validate:
      - eq: [content.0.orderStatusDesc,"订单处理中"]
      - eq: [content.0.orderDetail.carItemStatus, 9]
    setup_hooks:
      - ${order_status_change_time($orderstatustimeout,$environment)}

  - name: 获取完善还款信息二维码 api/mall/orders/GET_UserBankInfoUrl.yml
    api: api/mall/orders/GET_UserBankInfoUrl.yml
    setup_hooks:
      - ${sql_init_tqtl_repayment($phoneNum)}
      - ${sql_init_tonglian_pay($phoneNum,TQ)}
      - ${sql_init_repayment($phoneNum)}
      - ${sleep(5)}
    variables:
      orderId: $orderId
    validate:
      - eq: [status_code,200]

  - name: 获取用户还款方式还款信息记录  api/mall/mallSignAgreementInfo/tqtl/GET_Checkout.yml
    api: api/mall/mallSignAgreementInfo/tqtl/GET_Checkout.yml
    variables:
      orderId: $orderId
      payment: 2
    validate:
      - eq: [status_code,200]

  - name: 获取用户完善还款信息情况  api/mall/mallSignAgreementInfo/tqtl/GET_BankInfo.yml
    api: api/mall/mallSignAgreementInfo/tqtl/GET_BankInfo.yml
    variables:
      orderId: $orderId
      payment: 2
    validate:
      - eq: [status_code,200]

  - name: 万向通联还款方式-获取验证码  api/mall/mallSignAgreementInfo/wxtl/POST_Note.yml
    api: api/mall/mallSignAgreementInfo/wxtl/POST_Note.yml
    variables:
      orderId: $orderId
    validate:
      - eq: [status_code,200]

  - name: 万向通联还款方式-提交  api/mall/mallSignAgreementInfo/wxtl/POST_Sign.yml
    api: api/mall/mallSignAgreementInfo/wxtl/POST_Sign.yml
    setup_hooks:
      - ${sql_init_repayment($phoneNum)}
    variables:
        orderId: $orderId
    validate:
      - eq: [status_code,200]

  - name: 确认开通成功 api/mall/orders/GET_NotCompleteRepaymentQuantity.yml
    api: api/mall/orders/GET_NotCompleteRepaymentQuantity.yml
    validate:
      - eq: [status_code,200]

  - name: 搜索订单，验证订单状态：待签署合同 api/mall/back-end/orders/POST_Params.yml
    api: api/mall/back-end/orders/POST_Params.yml
    variables:
        tradeNo: ${tradeNo}
    validate:
      - eq: [content.0.orderStatusDesc,"待签署合同"]
      - eq: [content.0.orderDetail.carItemStatus, 9]

  - name: 签署合同  testcases/contracts/sign_contract.yml
    testcase: testcases/contracts/sign_contract.yml
    validate:
      - eq: [status_code,200]

  - name: 验证订单状态：待确认提车 api/mall/back-end/orders/POST_Params.yml
    api: api/mall/back-end/orders/POST_Params.yml
    variables:
        tradeNo: ${tradeNo}
    validate:
      - eq: [content.0.orderStatusDesc,"待确认提车"]

  - name: 提车 testcases/order/mention_car.yml
    testcase: testcases/order/mention_car.yml
    validate:
      - eq: [status_code,200]

  - name: 验证订单状态：交易完成 api/mall/back-end/orders/POST_Params.yml
    api: api/mall/back-end/orders/POST_Params.yml
    variables:
        tradeNo: ${tradeNo}
    validate:
      - eq: [content.0.orderStatusDesc,"交易完成"]
      - eq: [content.0.orderDetail.carItemStatus, 99]

  - name: 验证库存：已锁车、售出  api/supplychain/GET_Cars.yml
    api: api/supplychain/GET_Cars.yml
    variables:
        vin: ${vin}
        carTypeName: ""
    validate:
        - eq: [status_code,200]
        - eq: [content.0.locked, true]
        - eq: [content.0.sold, true]
        - eq: [content.0.tradeNo,$tradeNo]

  - name: 更新客户outerKey  api/usercenter/users/POST_Customer.yml
    api: api/usercenter/users/POST_Customer.yml
    variables:
      queryName: ${ENV(phoneNum)}
    validate:
      - eq: [status_code,200]