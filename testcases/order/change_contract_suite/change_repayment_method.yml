config:
    name: 更换合同套件:还款方式 testcases/order/change_contract_suite/change_repayment_method.yml
    variables:
        carFullName: 'AutoTestCarBrandAHTHKFS'

teststeps:
  - name: 添加待售车辆  testcases/supply/create_car.yml
    testcase: testcases/supply/create_car.yml
    variables:
      carFullName: ${carFullName}
    setup_hooks:
      - ${run_audit_order()}
      - ${run_get_user_message()}
    validate:
      - eq: [status_code,200]

  - name: 获取待售车辆  api/supplychain/GET_UnlockedCars.yml
    api: api/supplychain/GET_UnlockedCars.yml
    variables:
      carTypeName: ${carFullName}
      isLocked: 0
      carStstus: 4
    validate:
      - eq: [status_code,200]
    extract:
      vin: content.0.vin
    output:
      - vin

  - name: 获取车辆ID api/mall/car-items/POST_LeaseParams.yml
    api: api/mall/car-items/POST_LeaseParams.yml
    variables:
      keyword: ${carFullName}
    validate:
      - eq: [status_code,200]
    teardown_hooks:
      - ${save_car_id_from_response($response,$keyword)}

  - name: 下单 testcases/order/APP_create_order.yml
    testcase: testcases/order/APP_create_order.yml
    variables:
      keyword: ${carFullName}
    validate:
      - eq: [status_code,200]

  - name: 获取订单号 api/mall/salesman/POST_Order.yml
    api: api/mall/salesman/POST_Order.yml
    validate:
      - eq: [status_code,200]
    extract:
      - tradeNo: content.0.tradeNo
      - orderId: content.0.orderId

  - name: 验证库存：已锁车、待售  api/supplychain/GET_Cars.yml
    api: api/supplychain/GET_Cars.yml
    variables:
      vin: ${vin}
    validate:
      - eq: [status_code,200]
      - eq: [content.0.locked, true]
      - eq: [content.0.sold, false]
      - eq: [content.0.tradeNo,$tradeNo]

  - name: 验证订单状态：等待审核 api/mall/back-end/orders/POST_Params.yml
    api: api/mall/back-end/orders/POST_Params.yml
    variables:
      tradeNo: ${tradeNo}
    validate:
      - eq: [content.0.orderStatusDesc,"等待审核"]
      - eq: [content.0.orderDetail.carItemStatus, 9]

  - name: 信审账号登录  testcases/login/trial_account_login.yml
    testcase: testcases/login/trial_account_login.yml
    validate:
      - eq: [status_code,200]
    setup_hooks:
      - ${sleep(120)}

  - name: 审核订单  testcases/order/audit_order.yml
    testcase: testcases/order/audit_order.yml
    validate:
      - eq: [status_code,200]

  - name: 验证订单状态：订单处理中 api/mall/back-end/orders/POST_Params.yml
    api: api/mall/back-end/orders/POST_Params.yml
    variables:
      tradeNo: ${tradeNo}
    validate:
      - eq: [content.0.orderStatusDesc,"订单处理中"]
      - eq: [content.0.orderDetail.carItemStatus, 9]
    setup_hooks:
      - ${sleep(10)}

  - name: 客户完善还款信息  testcases/order/perfect_repayment_info.yml
    testcase: testcases/order/perfect_repayment_info.yml
    setup_hooks:
      - ${sql_init_repayment($phoneNum)}
    validate:
      - eq: [status_code,200]

  - name: 搜索订单，验证订单状态：待签署合同 api/mall/back-end/orders/POST_Params.yml
    api: api/mall/back-end/orders/POST_Params.yml
    variables:
      tradeNo: ${tradeNo}
    validate:
      - eq: [content.0.orderStatusDesc,"待签署合同"]
      - eq: [content.0.orderDetail.carItemStatus, 9]

  - name: 签署合同  testcases/contracts/sign_contract.yml
    testcase: testcases/contracts/sign_contract.yml
    validate:
      - eq: [status_code,200]

  - name: 验证订单状态：待确认提车 api/mall/back-end/orders/POST_Params.yml
    api: api/mall/back-end/orders/POST_Params.yml
    variables:
      tradeNo: ${tradeNo}
    validate:
      - eq: [content.0.orderStatusDesc,"待确认提车"]

  - name: 获取合同套件  api/contract/GET_ContractTemplateSuites.yml
    api: api/contract/GET_ContractTemplateSuites.yml
    variables:
        contract_name: '建行划扣-完善还款信息'
    validate:
      - eq: [status_code,200]

  - name: 配置金融方案  api/mall/back-end/car-lease-plans/POST_Item.yml
    api: api/mall/back-end/car-lease-plans/POST_Item.yml
    variables:
      itemId: ${get_value_from_tmp(carId)}
      downPayment: 10000
      monthlyPayment: 10000
      month: 20
    validate:
      - eq: [status_code,200]
    extract:
      id: content.0.id